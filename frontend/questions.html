<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QPGen ‚Äî Question Bank</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg: #f3f3f0; --white: #fff; --border: #e5e5e0; --text: #111; --muted: #888; --sw: 220px; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

        .sidebar { width: var(--sw); min-height: 100vh; background: #fff; border-right: 1px solid var(--border); padding: 20px 12px; display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; }
        .sidebar-logo { display: flex; align-items: center; gap: 10px; padding: 6px 10px; margin-bottom: 28px; }
        .logo-box { width: 30px; height: 30px; background: #111; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .logo-text { font-weight: 900; font-size: 1em; color: #111; }
        .nav-section-label { font-size: 0.65em; font-weight: 700; color: #bbb; text-transform: uppercase; letter-spacing: 1px; padding: 0 10px; margin-bottom: 4px; margin-top: 16px; }
        .nav-item { display: flex; align-items: center; gap: 9px; padding: 8px 10px; border-radius: 6px; font-size: 0.85em; font-weight: 500; color: #555; cursor: pointer; transition: all 0.15s; text-decoration: none; margin-bottom: 1px; }
        .nav-item:hover { background: #f5f5f3; color: #111; }
        .nav-item.active { background: #f0f0ee; color: #111; font-weight: 600; }
        .nav-item .icon { width: 18px; text-align: center; }
        .sidebar-bottom { margin-top: auto; border-top: 1px solid var(--border); padding-top: 16px; }
        .user-row { display: flex; align-items: center; gap: 9px; padding: 8px 10px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
        .user-row:hover { background: #f5f5f3; }
        .avatar { width: 28px; height: 28px; border-radius: 50%; background: #111; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.72em; font-weight: 700; flex-shrink: 0; }
        .user-name { font-size: 0.82em; font-weight: 600; }
        .user-sub { font-size: 0.7em; color: var(--muted); }

        .main { margin-left: var(--sw); flex: 1; }

        /* Page banner */
        .page-banner { background: #1e1b4b; padding: 36px 48px; position: relative; overflow: hidden; }
        .page-banner::before { content: ''; position: absolute; inset: 0; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 32px 32px; }
        .page-banner h1 { font-size: 2em; font-weight: 900; color: white; letter-spacing: -1px; margin-bottom: 4px; position: relative; z-index: 1; }
        .page-banner p { color: rgba(255,255,255,0.4); font-size: 0.86em; position: relative; z-index: 1; }
        .page-banner-deco { position: absolute; right: 48px; top: 50%; transform: translateY(-50%); font-size: 5em; opacity: 0.08; }

        .content { padding: 32px 48px; }

        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; flex-wrap: wrap; }
        .filters { display: flex; gap: 8px; flex-wrap: wrap; }

        select { padding: 8px 12px; border: 1.5px solid var(--border); border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 0.82em; font-weight: 600; color: var(--text); background: white; outline: none; cursor: pointer; transition: border-color 0.2s; }
        select:focus { border-color: #111; }

        .btn-add { padding: 9px 18px; border-radius: 7px; font-size: 0.84em; font-weight: 800; cursor: pointer; border: none; font-family: 'Inter', sans-serif; background: #111; color: white; letter-spacing: -0.2px; transition: opacity 0.2s; }
        .btn-add:hover { opacity: 0.75; }

        .table-wrap { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .t-head { display: grid; grid-template-columns: 2.2fr 1fr 1fr 1fr 80px 70px; padding: 12px 20px; background: #fafaf8; border-bottom: 1px solid var(--border); font-size: 0.71em; font-weight: 800; color: #999; text-transform: uppercase; letter-spacing: 0.6px; }
        .t-row { display: grid; grid-template-columns: 2.2fr 1fr 1fr 1fr 80px 70px; padding: 15px 20px; border-bottom: 1px solid #f8f8f5; align-items: center; transition: background 0.15s; }
        .t-row:last-child { border-bottom: none; }
        .t-row:hover { background: #fafaf8; }
        .q-text { font-size: 0.86em; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }

        .badge { display: inline-flex; align-items: center; padding: 3px 9px; border-radius: 4px; font-size: 0.71em; font-weight: 800; letter-spacing: 0.2px; }
        .br { background: #eef2ff; color: #4338ca; }
        .bu { background: #eff6ff; color: #1d4ed8; }
        .ba { background: #f0fdf4; color: #15803d; }
        .ban { background: #fffbeb; color: #b45309; }
        .be { background: #fef2f2; color: #b91c1c; }
        .bc { background: #fdf2f8; color: #be185d; }
        .de { background: #f0fdf4; color: #15803d; }
        .dm { background: #fffbeb; color: #b45309; }
        .dh { background: #fef2f2; color: #b91c1c; }

        .marks { font-size: 0.84em; font-weight: 800; color: #111; }
        .btn-del { padding: 5px 10px; border-radius: 5px; font-size: 0.73em; font-weight: 700; cursor: pointer; border: 1px solid #fecaca; background: #fff5f5; color: #dc2626; font-family: 'Inter', sans-serif; transition: background 0.15s; }
        .btn-del:hover { background: #fee2e2; }

        .empty-state { text-align: center; padding: 52px; color: var(--muted); }
        .empty-icon { font-size: 3em; margin-bottom: 12px; }

        /* Modal */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s; backdrop-filter: blur(6px); }
        .overlay.open { opacity: 1; pointer-events: all; }
        .modal { background: white; border-radius: 14px; padding: 32px; width: 100%; max-width: 520px; box-shadow: 0 32px 80px rgba(0,0,0,0.2); transform: translateY(8px); transition: transform 0.2s; }
        .overlay.open .modal { transform: translateY(0); }
        .m-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .m-title { font-size: 1.1em; font-weight: 900; letter-spacing: -0.5px; }
        .m-close { background: #f5f5f3; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 0.85em; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.76em; font-weight: 700; color: #555; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
        input, textarea, select.fs { width: 100%; padding: 10px 13px; border: 1.5px solid #e5e5e0; border-radius: 7px; font-family: 'Inter', sans-serif; font-size: 0.88em; color: #111; background: #fafaf8; outline: none; transition: all 0.2s; }
        input:focus, textarea:focus, select.fs:focus { border-color: #111; background: white; }
        textarea { resize: vertical; min-height: 80px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .msg { padding: 10px 14px; border-radius: 7px; font-size: 0.82em; margin-bottom: 14px; display: none; font-weight: 600; }
        .msg.error { background: #fef2f2; border: 1.5px solid #fecaca; color: #dc2626; }
        .msg.success { background: #f0fdf4; border: 1.5px solid #bbf7d0; color: #16a34a; }
        .m-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { padding: 9px 16px; border-radius: 7px; font-size: 0.83em; font-weight: 600; cursor: pointer; border: 1.5px solid #e5e5e0; background: white; color: #111; font-family: 'Inter', sans-serif; }
        .btn-save { padding: 9px 18px; border-radius: 7px; font-size: 0.83em; font-weight: 800; cursor: pointer; border: none; background: #111; color: white; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo"><div class="logo-box">üéì</div><span class="logo-text">QPGen</span></div>
        <div class="nav-section-label">Workspace</div>
        <a class="nav-item" href="dashboard.html"><span class="icon">üè†</span> Home</a>
        <a class="nav-item active" href="questions.html"><span class="icon">üìö</span> Question Bank</a>
        <a class="nav-item" href="generate.html"><span class="icon">‚ö°</span> Generate Paper</a>
        <div class="sidebar-bottom">
            <div class="user-row" onclick="logout()">
                <div class="avatar" id="av">N</div>
                <div><div class="user-name" id="uName">User</div><div class="user-sub">Sign out</div></div>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="page-banner">
            <h1>üìö Question Bank</h1>
            <p>Browse, filter and manage your full question repository</p>
            <div class="page-banner-deco">üìö</div>
        </div>

        <div class="content">
            <div class="toolbar">
                <div class="filters">
                    <select id="fSubject" onchange="loadQ()"><option value="">All Subjects</option></select>
                    <select id="fBlooms" onchange="loadQ()">
                        <option value="">All Bloom's</option>
                        <option value="remember">Remember</option>
                        <option value="understand">Understand</option>
                        <option value="apply">Apply</option>
                        <option value="analyze">Analyze</option>
                        <option value="evaluate">Evaluate</option>
                        <option value="create">Create</option>
                    </select>
                    <select id="fDiff" onchange="loadQ()">
                        <option value="">All Difficulties</option>
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                <button class="btn-add" onclick="openModal()">+ Add Question</button>
            </div>

            <div class="table-wrap">
                <div class="t-head"><div>Question</div><div>Bloom's</div><div>Difficulty</div><div>Type</div><div>Marks</div><div></div></div>
                <div id="qList"><div class="empty-state"><div class="empty-icon">üìö</div><p>Loading...</p></div></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="overlay" id="overlay" onclick="handleO(event)">
        <div class="modal">
            <div class="m-head">
                <span class="m-title">Add New Question</span>
                <button class="m-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="msg error" id="mErr"></div>
            <div class="msg success" id="mSuc"></div>
            <div class="form-group"><label>Question Text</label><textarea id="qText" placeholder="Type your question here..."></textarea></div>
            <div class="form-row">
                <div class="form-group"><label>Subject</label><select class="fs" id="qSub"></select></div>
                <div class="form-group"><label>Type</label><select class="fs" id="qType"><option value="short">Short Answer</option><option value="long">Long Answer</option><option value="mcq">MCQ</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Bloom's Level</label><select class="fs" id="qBlooms"><option value="remember">Remember</option><option value="understand">Understand</option><option value="apply">Apply</option><option value="analyze">Analyze</option><option value="evaluate">Evaluate</option><option value="create">Create</option></select></div>
                <div class="form-group"><label>Difficulty</label><select class="fs" id="qDiff"><option value="easy">Easy</option><option value="medium">Medium</option><option value="hard">Hard</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Marks</label><input type="number" id="qMarks" placeholder="5" min="1"></div>
                <div class="form-group"><label>Answer (optional)</label><input type="text" id="qAns" placeholder="Correct answer..."></div>
            </div>
            <div class="m-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-save" onclick="addQ()" id="addBtn">Add Question</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://127.0.0.1:5000/api';
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'index.html';
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('uName').textContent = user.username || 'User';
        document.getElementById('av').textContent = (user.username||'U')[0].toUpperCase();
        const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

        const bb = { remember:'br', understand:'bu', apply:'ba', analyze:'ban', evaluate:'be', create:'bc' };
        const db = { easy:'de', medium:'dm', hard:'dh' };

        async function loadSubjects() {
            const res = await fetch(`${API}/subjects/`, { headers });
            const data = await res.json();
            (data.subjects||[]).forEach(s => {
                document.getElementById('fSubject').innerHTML += `<option value="${s.id}">${s.name}</option>`;
                document.getElementById('qSub').innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
        }

        async function loadQ() {
            let url = `${API}/questions/?`;
            const s = document.getElementById('fSubject').value;
            const b = document.getElementById('fBlooms').value;
            const d = document.getElementById('fDiff').value;
            if (s) url += `subject_id=${s}&`;
            if (b) url += `blooms_level=${b}&`;
            if (d) url += `difficulty=${d}&`;
            const res = await fetch(url, { headers });
            const data = await res.json();
            const qs = data.questions || [];
            const el = document.getElementById('qList');
            if (!qs.length) { el.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><p>No questions found.</p></div>`; return; }
            el.innerHTML = qs.map(q => `
                <div class="t-row">
                    <div class="q-text">${q.text}</div>
                    <div><span class="badge ${bb[q.blooms_level]||''}">${q.blooms_level}</span></div>
                    <div><span class="badge ${db[q.difficulty]||''}">${q.difficulty}</span></div>
                    <div style="font-size:0.8em;color:#888;font-weight:700">${q.question_type}</div>
                    <div class="marks">${q.marks} pts</div>
                    <div><button class="btn-del" onclick="delQ(${q.id})">Delete</button></div>
                </div>`).join('');
        }

        async function delQ(id) {
            if (!confirm('Delete this question?')) return;
            await fetch(`${API}/questions/${id}`, { method:'DELETE', headers });
            loadQ();
        }

        function openModal() { document.getElementById('overlay').classList.add('open'); }
        function closeModal() { document.getElementById('overlay').classList.remove('open'); document.getElementById('mErr').style.display='none'; document.getElementById('mSuc').style.display='none'; }
        function handleO(e) { if (e.target===document.getElementById('overlay')) closeModal(); }

        async function addQ() {
            const text = document.getElementById('qText').value.trim();
            const subject_id = document.getElementById('qSub').value;
            const question_type = document.getElementById('qType').value;
            const blooms_level = document.getElementById('qBlooms').value;
            const difficulty = document.getElementById('qDiff').value;
            const marks = parseInt(document.getElementById('qMarks').value);
            const correct_answer = document.getElementById('qAns').value.trim();
            const err = document.getElementById('mErr'), suc = document.getElementById('mSuc');
            if (!text || !subject_id || !marks) { err.textContent='Fill in all required fields.'; err.style.display='block'; return; }
            const btn = document.getElementById('addBtn');
            btn.textContent='Adding...'; btn.disabled=true;
            try {
                const res = await fetch(`${API}/questions/`, { method:'POST', headers, body: JSON.stringify({text, subject_id:parseInt(subject_id), question_type, blooms_level, difficulty, marks, correct_answer}) });
                const data = await res.json();
                if (!res.ok) { err.textContent=data.error||'Failed.'; err.style.display='block'; return; }
                suc.textContent='Question added!'; suc.style.display='block'; err.style.display='none';
                document.getElementById('qText').value=''; document.getElementById('qMarks').value=''; document.getElementById('qAns').value='';
                setTimeout(()=>{ closeModal(); loadQ(); }, 900);
            } catch { err.textContent='Server error.'; err.style.display='block'; }
            finally { btn.textContent='Add Question'; btn.disabled=false; }
        }

        function logout() { localStorage.clear(); window.location.href='index.html'; }
        loadSubjects(); loadQ();
    </script>
</body>
</html>
